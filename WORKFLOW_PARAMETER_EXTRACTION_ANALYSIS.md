# RAVEN Workflow Parameter Extraction Analysis: Steps 1-4

## Executive Summary

Based on detailed analysis of the RAVEN workflow Steps 1-4 and comparison with BasinMaker logic, I've identified **critical data extraction gaps** that cause Step 5 failures. The issue is not missing fallbacks, but **missing extraction** of core BasinMaker parameters at the subbasin level.

## Root Cause: Wrong Data Model

**Current (Wrong) Approach:**
- Step 5 tries to extract `CHANNEL_PROF` and `GAUGED` from HRU data
- BasinMaker expects these at the **SUBBASIN level**

**Correct BasinMaker Approach:**
- `CHANNEL_PROF` = channel profile name per subbasin (`"Chn_14"`, `"Chn_17"`, etc.)
- `GAUGED` = observation point flag per subbasin (0/1)

## Critical Missing Parameters by Step

### Step 1: Data Preparation
**Current Output:** DEM, landcover, soil data
**Missing:** Nothing - Step 1 correctly downloads spatial data

### Step 2: Watershed Delineation  
**Current Output:** Subbasins, streams, outlet point
**Missing:** Critical subbasin attributes for BasinMaker compatibility:
- `Has_POI` or `Has_Gauge` (observation point flag)
- `DowSubId` (downstream subbasin ID for routing)
- `RivLength` (river length per subbasin)
- `RivSlope` (river slope per subbasin)  
- `BkfWidth` (bankfull width)
- `BkfDepth` (bankfull depth)
- `Ch_n` (channel Manning's n)
- `FloodP_n` (floodplain Manning's n)
- `MeanElev` (mean elevation)

**Current subbasins.shp columns:** `['SubId', 'FID', 'VALUE', 'area_km2', 'Original_S', 'geometry']`

### Step 3: Lake Processing & Hydraulic Routing
**Current Output:** 
- Channel profiles in `step3_results.json['channel_profiles']` (✅ CORRECT)
- Hydraulic parameters in `watershed_routing_hydraulic_parameters.csv` (✅ PARTIALLY CORRECT)

**What Step 3 Actually Generates:**
```json
"channel_profiles": [
  ":ChannelProfile CHANNEL_14\n  :Bedslope 0.004272...",
  ":ChannelProfile CHANNEL_17\n  :Bedslope 0.003566...",
  ":ChannelProfile CHANNEL_19\n  :Bedslope 0.002557..."
]
```

**Hydraulic Parameters CSV Contains:**
```csv
SubId,DowSubId,DrainArea,RivLength,RivSlope,MeanElev,discharge_m3s,channel_width_m,channel_depth_m,channel_slope,manning_n,...
14,25,5479909.291689987,3212.2542437395405,0.004271823643648302,710.1737670898438,...
```

**Missing Integration:** Step 3 generates the data but doesn't update the subbasin shapefiles!

### Step 4: HRU Generation
**Current Output:** HRU polygons with land use, vegetation, soil classifications
**Missing:** Nothing - Step 4 correctly generates HRUs with proper attributes

**Current HRU columns:** `['Landuse_ID', 'LAND_USE_C', 'VEG_C', 'Soil_ID', 'SOIL_PROF', 'SubId', 'HRU_Area', 'geometry']`

## The Real Problem: Data Integration Failure

### Issue 1: Channel Profile Mapping Missing
**Generated by Step 3:** Channel profiles (`CHANNEL_14`, `CHANNEL_17`, etc.)
**Expected by Step 5:** `CHANNEL_PROF` column in subbasin data  
**Current Status:** ❌ Not mapped back to subbasins

### Issue 2: Observation Point Data Missing  
**Required by BasinMaker:** `Has_POI` or `Has_Gauge` column in subbasin data
**Used to determine:** `GAUGED` attribute (0/1)
**Current Status:** ❌ Never integrated into subbasin data

### Issue 3: Hydraulic Parameters Isolated
**Generated by Step 3:** Complete hydraulic parameters in CSV file
**Expected by Step 5:** Parameters attached to subbasin shapefile
**Current Status:** ❌ Data exists but not integrated

## Correct BasinMaker Workflow Logic

Based on BasinMaker source code analysis:

### Subbasin Attributes (Lines 1672-1680):
```python
# BasinMaker logic for GAUGED attribute
if catinfo_sub[Gauge_col_Name].values[i] > 0:
    Guage = "1"  # Has observation point
elif catinfo_sub["Lake_Cat"].values[i] > 0 and Lake_As_Gauge == True:
    Guage = "1"  # Lake subbasin marked as gauged
else:
    Guage = "0"
```

### Channel Profile Names (Lines 1613-1615):
```python
# BasinMaker logic for channel profiles
if strRlen != "ZERO-":
    pronam = "Chn_" + Strcat  # e.g., "Chn_14"
else:
    pronam = "Chn_ZERO_LENGTH"
```

### Required Subbasin Fields:
1. `SubId` ✅ (already exists)
2. `DowSubId` ⚠️ (generated in CSV but not in shapefile)
3. `Has_POI` or `Has_Gauge` ❌ (missing entirely)
4. `RivLength` ⚠️ (generated in CSV but not in shapefile)  
5. `RivSlope` ⚠️ (generated in CSV but not in shapefile)
6. `BkfWidth`, `BkfDepth` ⚠️ (calculated but not attached to subbasins)
7. `Ch_n`, `FloodP_n` ⚠️ (calculated but not attached to subbasins)
8. `MeanElev` ⚠️ (calculated but not attached to subbasins)

## Required Fixes

### Fix 1: Integrate Hydraulic Parameters into Subbasin Shapefiles
**Location:** End of Step 3
**Action:** Update `subbasins_with_lakes.shp` with hydraulic parameters from CSV
```python
# Merge hydraulic parameters back into subbasin shapefile
subbasins_gdf = gpd.read_file(subbasins_path)
hydraulic_df = pd.read_csv(hydraulic_params_csv)
enhanced_subbasins = subbasins_gdf.merge(hydraulic_df[['SubId', 'DowSubId', 'RivLength', 'RivSlope', 'BkfWidth', 'BkfDepth', 'Ch_n', 'FloodP_n', 'MeanElev']], on='SubId')
```

### Fix 2: Add Channel Profile Mapping
**Location:** Step 5 initialization  
**Action:** Map channel profiles from `step3_results.json` to subbasins
```python
# Extract channel profile names and map to SubIds
step3_results = load_json("step3_results.json")
channel_profiles = step3_results['routing_config']['channel_profiles']
# Extract CHANNEL_14, CHANNEL_17, etc. and map to SubId 14, 17, etc.
```

### Fix 3: Add Observation Point Integration
**Location:** Step 6 (or new step)
**Action:** Integrate hydrometric station data to set `Has_POI` flag
```python
# Load hydrometric stations and spatial join with subbasins
# Set Has_POI = 1 for subbasins containing or near stations
```

### Fix 4: Fix Coordinate Conversion 
**Location:** Step 4 HRU generation
**Action:** Ensure `HRU_CenX`/`HRU_CenY` are in geographic coordinates (EPSG:4326)
**Current Issue:** Values like `358369.97028328135` are UTM, not lat/lon degrees

## Verification: Expected Final Data Structure

### Enhanced Subbasins Shapefile Should Contain:
```
SubId | DowSubId | Has_POI | RivLength | RivSlope | BkfWidth | BkfDepth | Ch_n | FloodP_n | MeanElev | CHANNEL_PROF | geometry
14    | 25       | 0       | 3212.25   | 0.00427  | 1.12     | 0.3      | 0.15 | 0.15     | 710.17   | CHANNEL_14   | POLYGON(...)
17    | 19       | 0       | 2845.67   | 0.00357  | 1.34     | 0.3      | 0.15 | 0.15     | 682.45   | CHANNEL_17   | POLYGON(...)
```

### Step 5 Should Extract From:
- **Subbasins:** `CHANNEL_PROF`, `GAUGED` (derived from `Has_POI`)
- **HRUs:** Land use, vegetation, soil classes, coordinates (in lat/lon degrees)

## Implementation Priority

1. **HIGH:** Integrate hydraulic parameters from CSV into subbasin shapefile (Step 3)
2. **HIGH:** Add channel profile name mapping (Step 5)  
3. **HIGH:** Fix HRU coordinate system (Step 4)
4. **MEDIUM:** Add observation point integration (new step or Step 6)
5. **LOW:** Remove unnecessary fallbacks in Step 5 (after data issues fixed)

## Impact Assessment

**Current State:** Step 5 fails due to missing required BasinMaker attributes
**After Fixes:** Complete RAVEN model generation with proper subbasin-level routing parameters
**Benefit:** Eliminates need for hard-coded fallbacks by providing real extracted data

---

**Generated:** 2025-01-11
**Analysis Covers:** Steps 1-4 of RAVEN watershed delineation workflow
**Next Actions:** Implement data integration fixes before removing fallbacks